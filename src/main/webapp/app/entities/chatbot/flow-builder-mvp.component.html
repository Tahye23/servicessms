<!-- flow-builder-mvp.component.html - VERSION COMPL√àTE ET STRUCTUR√âE -->
<div class="h-screen bg-gray-50 flex">
  <!-- ================================ -->
  <!-- SIDEBAR GAUCHE - Palette de n≈ìuds -->
  <!-- ================================ -->
  <!-- OVERLAY pour mobile (optionnel) -->
  <div *ngIf="showLeftSidebar" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden" (click)="toggleLeftSidebar()"></div>

  <!-- SIDEBAR GAUCHE - Avec animation -->
  <div
    [class]="
      'bg-white shadow-lg flex flex-col border-r transition-all duration-300 z-50 ' +
      (showLeftSidebar ? 'w-80 flex-shrink-0' : 'w-0 overflow-hidden')
    "
  >
    <!-- Header -->
    <div class="p-4 border-b bg-blue-600 text-white flex items-center justify-between min-w-80">
      <div class="flex items-center">
        <i class="fas fa-robot mr-2"></i>
        <div>
          <h1 class="text-xl font-bold">Flow Builder</h1>
          <p class="text-blue-100 text-sm">Palette d'√©l√©ments</p>
        </div>
      </div>

      <button (click)="toggleLeftSidebar()" class="p-2 hover:bg-blue-700 rounded transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- N≈ìuds disponibles -->
    <div class="flex-1 overflow-y-auto p-4">
      <h3 class="font-semibold mb-4 text-gray-800">√âl√©ments disponibles</h3>

      <!-- Messages & M√©dias -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-600 mb-2">üìù Messages & M√©dias</h4>
        <div class="space-y-2">
          <button
            *ngFor="let nodeType of getNodesByCategory('message')"
            (click)="addNode(nodeType.type)"
            class="w-full flex items-center p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all bg-white text-left group"
          >
            <div [class]="'p-2 rounded-lg text-white mr-3 ' + nodeType.color">
              <i [class]="nodeType.icon + ' text-sm'"></i>
            </div>
            <div class="flex-1">
              <span class="font-medium text-gray-800 text-sm">{{ nodeType.label }}</span>
            </div>
            <button
              (click)="showNodeHelp(nodeType.type); $event.stopPropagation()"
              class="opacity-0 group-hover:opacity-100 text-xs text-gray-400 hover:text-gray-600 transition-opacity"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </button>
        </div>
      </div>

      <!-- Interactions -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-600 mb-2">üîò Interactions</h4>
        <div class="space-y-2">
          <button
            *ngFor="let nodeType of getNodesByCategory('interaction')"
            (click)="addNode(nodeType.type)"
            class="w-full flex items-center p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all bg-white text-left group"
          >
            <div [class]="'p-2 rounded-lg text-white mr-3 ' + nodeType.color">
              <i [class]="nodeType.icon + ' text-sm'"></i>
            </div>
            <div class="flex-1">
              <span class="font-medium text-gray-800 text-sm">{{ nodeType.label }}</span>
            </div>
            <button
              (click)="showNodeHelp(nodeType.type); $event.stopPropagation()"
              class="opacity-0 group-hover:opacity-100 text-xs text-gray-400 hover:text-gray-600 transition-opacity"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </button>
        </div>
      </div>

      <!-- Logique -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-600 mb-2">üß† Logique</h4>
        <div class="space-y-2">
          <button
            *ngFor="let nodeType of getNodesByCategory('logic')"
            (click)="addNode(nodeType.type)"
            class="w-full flex items-center p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all bg-white text-left group"
          >
            <div [class]="'p-2 rounded-lg text-white mr-3 ' + nodeType.color">
              <i [class]="nodeType.icon + ' text-sm'"></i>
            </div>
            <div class="flex-1">
              <span class="font-medium text-gray-800 text-sm">{{ nodeType.label }}</span>
            </div>
            <button
              (click)="showNodeHelp(nodeType.type); $event.stopPropagation()"
              class="opacity-0 group-hover:opacity-100 text-xs text-gray-400 hover:text-gray-600 transition-opacity"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </button>
        </div>
      </div>

      <!-- Templates rapides -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-600 mb-2">üöÄ Templates rapides</h4>
        <div class="space-y-2">
          <button
            *ngFor="
              let template of [
                { id: 'welcome', title: 'üëã Accueil', desc: 'Flow d\'accueil basique' },
                { id: 'support', title: 'üÜò Support 3CX', desc: 'Transfert vers agent' },
                { id: 'survey', title: 'üìä Questionnaire', desc: 'Enqu√™te satisfaction' }
              ]
            "
            (click)="createQuickTemplate(template.id)"
            class="w-full p-2 border border-gray-200 rounded-lg hover:bg-gray-50 text-left transition-colors bg-white text-xs"
          >
            <div class="font-medium text-gray-800">{{ template.title }}</div>
            <div class="text-gray-500">{{ template.desc }}</div>
          </button>
        </div>
      </div>

      <!-- Variables globales -->
      <div class="bg-blue-50 p-4 rounded-lg border">
        <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
          <i class="fas fa-database mr-2 text-blue-600"></i>
          Variables ({{ flowConfig.variables.length }})
        </h4>
        <div class="space-y-2">
          <div *ngFor="let variable of flowConfig.variables; let i = index" class="flex justify-between items-center text-sm">
            <span class="text-gray-700 truncate" [title]="variable.description">{{ variable.name }}</span>
            <button (click)="removeVariable(i)" class="text-red-600 hover:text-red-800 ml-2">
              <i class="fas fa-trash text-xs"></i>
            </button>
          </div>
          <button
            (click)="addVariable()"
            class="w-full p-2 border-2 border-dashed border-blue-300 rounded text-blue-600 hover:bg-blue-50 text-sm"
          >
            <i class="fas fa-plus mr-1"></i> Ajouter variable
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================ -->
  <!-- ZONE CENTRALE -->
  <!-- ================================ -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- Toolbar -->
    <div class="bg-white border-b p-4 flex items-center justify-between shadow-sm">
      <div class="flex items-center space-x-4">
        <button
          *ngIf="!showLeftSidebar"
          (click)="toggleLeftSidebar()"
          class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          <i class="fas fa-bars"></i>
        </button>
        <input
          [(ngModel)]="flowConfig.name"
          class="text-xl font-semibold bg-transparent border-none outline-none focus:bg-gray-50 rounded px-2 py-1"
          placeholder="Nom du flow"
        />
        <div class="flex items-center space-x-2">
          <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"> {{ nodes.length }} n≈ìuds </span>
          <span class="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            {{ flowConfig.variables.length }} variables
          </span>
          <span class="px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
            {{ getTotalConnectionCount() }} connexions
          </span>
          <span *ngIf="flowConfig.active" class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"> Actif </span>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <!-- Validation avanc√©e -->
        <button
          (click)="validateFlowAdvanced()"
          class="px-3 py-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition-colors"
          title="Validation avanc√©e du flow"
        >
          <i class="fas fa-check-circle"></i>
        </button>

        <div class="flex items-center bg-gray-100 rounded-lg p-1">
          <button
            (click)="zoomOut()"
            [disabled]="canvasZoom <= canvasMinZoom"
            class="p-2 hover:bg-white rounded transition-colors disabled:opacity-50"
            title="Zoom arri√®re"
          >
            <i class="fas fa-minus text-sm"></i>
          </button>

          <span class="px-3 text-sm font-medium min-w-16 text-center"> {{ canvasZoom * 100 | number: '1.0-0' }}% </span>

          <button
            (click)="zoomIn()"
            [disabled]="canvasZoom >= canvasMaxZoom"
            class="p-2 hover:bg-white rounded transition-colors disabled:opacity-50"
            title="Zoom avant"
          >
            <i class="fas fa-plus text-sm"></i>
          </button>

          <button (click)="resetZoom()" class="p-2 hover:bg-white rounded transition-colors ml-1" title="R√©initialiser le zoom">
            <i class="fas fa-expand-arrows-alt text-sm"></i>
          </button>
        </div>
        <!-- Divider -->
        <div class="h-6 w-px bg-gray-300"></div>

        <!-- Actions principales
        <button (click)="exportFlow()"
                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium text-sm">
          <i class="fas fa-download mr-2"></i>Exporter
        </button>

        <label class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium text-sm cursor-pointer">
          <i class="fas fa-upload mr-2"></i>Importer
          <input type="file" accept=".json" (change)="onImportFlow($event)" class="hidden">
        </label>-->

        <button
          (click)="saveFlow()"
          [disabled]="isSaving"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium text-sm disabled:opacity-50"
        >
          <i [class]="isSaving ? 'fas fa-spinner fa-spin mr-2' : 'fas fa-save mr-2'"></i>
          {{ isSaving ? 'Sauvegarde...' : 'Sauvegarder' }}
        </button>

        <button (click)="testFlow()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
          <i class="fas fa-play mr-2"></i>Tester
        </button>
      </div>
    </div>

    <!-- Canvas -->
    <div
      class="flex-1 relative overflow-auto bg-gray-100"
      [style.background-image]="'radial-gradient(circle, #e5e7eb 1px, transparent 1px)'"
      [style.background-size]="'20px 20px'"
      (click)="deselectNode()"
      (wheel)="onCanvasWheel($event)"
    >
      <!-- Container avec transformation zoom -->
      <div
        class="relative w-full h-full"
        [style.transform]="'scale(' + canvasZoom + ')'"
        [style.transform-origin]="'top left'"
        [style.width]="'5000px'"
        [style.height]="'5000px'"
      >
        <!-- SVG pour les connexions multiples -->
        <svg class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 1">
          <defs>
            <!-- Fl√®che standard -->
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280" />
            </marker>
            <!-- Fl√®che verte pour boutons -->
            <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#10B981" />
            </marker>
            <!-- Fl√®che violette pour listes -->
            <marker id="arrowhead-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#8B5CF6" />
            </marker>
            <!-- Fl√®che orange pour conditions -->
            <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#F59E0B" />
            </marker>
            <!-- Fl√®che rouge pour d√©faut -->
            <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444" />
            </marker>
          </defs>

          <!-- Connexions multiples pour chaque n≈ìud -->
          <g *ngFor="let node of nodes">
            <g *ngFor="let connection of getNodeConnections(node); let i = index">
              <ng-container *ngIf="getNodeById(connection.targetId) as targetNode">
                <!-- Ligne de connexion -->
                <path
                  [attr.d]="getConnectionPath(node, targetNode, i * 20)"
                  [attr.stroke]="connection.color"
                  stroke-width="2"
                  fill="none"
                  [attr.marker-end]="getMarkerEnd(connection.color)"
                  class="hover:stroke-opacity-75 transition-all cursor-pointer"
                  [attr.stroke-dasharray]="connection.label.includes('Sinon') ? '5,5' : 'none'"
                />

                <!-- Label de connexion -->
                <text
                  [attr.x]="getConnectionLabelX(node, targetNode, i * 20)"
                  [attr.y]="getConnectionLabelY(node, targetNode, i * 20)"
                  [attr.fill]="connection.color"
                  text-anchor="middle"
                  class="text-xs font-medium pointer-events-none"
                  [attr.dy]="i * 15"
                >
                  {{ connection.label }}
                </text>

                <!-- Petit cercle pour identifier la connexion -->
                <circle
                  [attr.cx]="getConnectionLabelX(node, targetNode, i * 20) - 30"
                  [attr.cy]="getConnectionLabelY(node, targetNode, i * 20) + i * 15"
                  r="3"
                  [attr.fill]="connection.color"
                  class="pointer-events-none"
                />
              </ng-container>
            </g>
          </g>
        </svg>

        <!-- N≈ìuds avec affichage am√©lior√© -->
        <div
          *ngFor="let node of nodes"
          [style.left.px]="node.x"
          [style.top.px]="node.y"
          [class]="
            'absolute bg-white rounded-lg shadow-lg border-2 cursor-pointer transition-all min-w-48 max-w-80 ' +
            (selectedNodeId === node.id ? 'border-blue-500 shadow-xl scale-105 z-10' : 'border-gray-200 hover:border-gray-300')
          "
          (click)="selectNode(node.id, $event)"
          (mousedown)="startDragging(node.id, $event)"
        >
          <!-- Badge d'ordre -->
          <div
            class="absolute -top-3 -left-3 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold"
          >
            {{ node.order }}
          </div>

          <!-- Badge du nombre de connexions -->
          <div
            *ngIf="getNodeConnections(node).length > 1"
            class="absolute -top-2 -right-2 w-5 h-5 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-bold"
          >
            {{ getNodeConnections(node).length }}
          </div>

          <!-- Header avec titre personnalisable -->
          <div [class]="'flex items-center px-3 py-2 rounded-t-lg text-white ' + getNodeColor(node.type)">
            <i [class]="getNodeIcon(node.type) + ' mr-2'"></i>
            <span class="text-sm font-medium flex-1">{{ getNodeDisplayLabel(node) }}</span>

            <!-- Bouton d'√©dition du titre -->
            <button
              *ngIf="selectedNodeId === node.id"
              (click)="editNodeLabel(node, $event)"
              class="hover:bg-black/20 rounded p-1 transition-colors mr-1"
              title="Modifier le titre"
            >
              <i class="fas fa-edit text-xs"></i>
            </button>

            <!-- Bouton de suppression -->
            <button
              *ngIf="node.type !== 'start'"
              (click)="deleteNode(node.id, $event)"
              class="hover:bg-black/20 rounded p-1 transition-colors"
            >
              <i class="fas fa-trash text-xs"></i>
            </button>
          </div>

          <!-- Contenu du n≈ìud avec plus d'infos -->
          <div class="p-3">
            <div [ngSwitch]="node.type">
              <!-- Start -->
              <div *ngSwitchCase="'start'" class="text-center py-2">
                <i class="fas fa-play text-2xl text-green-600 mb-2"></i>
                <div class="text-xs text-gray-600">Point de d√©part</div>
                <div *ngIf="node.nextNodeId" class="text-xs text-blue-600 mt-1">‚Üí N≈ìud {{ getNodeById(node.nextNodeId)?.order }}</div>
              </div>

              <!-- Message -->
              <div *ngSwitchCase="'message'" class="text-center py-2">
                <i class="fas fa-comment text-lg text-blue-600 mb-2"></i>
                <div class="text-xs text-gray-600 truncate max-w-full" [title]="node.data.text">
                  {{ node.data.text || 'Message vide' }}
                </div>
                <div *ngIf="node.data.useVariables" class="text-xs text-purple-600 mt-1">
                  <i class="fas fa-code text-xs mr-1"></i>Variables actives
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>
              <div *ngSwitchCase="'api_connector'" class="text-center py-2">
                <i class="fas fa-cloud text-lg text-violet-600 mb-2"></i>
                <div class="text-xs text-gray-600">{{ node.data.apiMethod || 'GET' }} {{ getApiDisplayUrl(node.data.apiUrl) }}</div>
                <div *ngIf="node.data.isApiValid" class="text-xs text-green-600 mt-1">
                  <i class="fas fa-check-circle text-xs mr-1"></i>Test√©e
                </div>
                <div *ngIf="node.data.responseMapping?.length" class="text-xs text-blue-600 mt-1">
                  {{ node.data.responseMapping?.length }} mapping(s)
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>
              <div *ngSwitchCase="'whatsapp_form'" class="text-center py-2">
                <i class="fas fa-wpforms text-lg text-emerald-600 mb-2"></i>
                <div class="text-xs text-gray-600">
                  {{ node.data.formTitle || 'Formulaire WhatsApp' }}
                </div>
                <div class="text-xs text-emerald-600 mt-1">{{ getEnabledFormFields(node).length }} champ(s)</div>
                <div *ngIf="node.data.isFormPublished" class="text-xs text-green-600 mt-1">
                  <i class="fas fa-check-circle text-xs mr-1"></i>Publi√©
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>
              <!-- Buttons avec compte -->
              <div *ngSwitchCase="'buttons'" class="text-center py-2">
                <i class="fas fa-list-ul text-lg text-green-600 mb-2"></i>
                <div class="text-xs text-gray-600">{{ node.data.buttons?.length || 0 }} bouton(s)</div>
                <div *ngIf="node.data.storeInVariable" class="text-xs text-blue-600 mt-1">‚Üí {{ node.data.storeInVariable }}</div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- List avec compte -->
              <div *ngSwitchCase="'list'" class="text-center py-2">
                <i class="fas fa-bars text-lg text-purple-600 mb-2"></i>
                <div class="text-xs text-gray-600">{{ node.data.items?.length || 0 }} option(s)</div>
                <div *ngIf="node.data.storeInVariable" class="text-xs text-blue-600 mt-1">‚Üí {{ node.data.storeInVariable }}</div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- Input -->
              <div *ngSwitchCase="'input'" class="text-center py-2">
                <i class="fas fa-edit text-lg text-indigo-600 mb-2"></i>
                <div class="text-xs text-gray-600">Saisie {{ node.data.responseType || 'texte' }}</div>
                <div *ngIf="node.data.storeInVariable" class="text-xs text-blue-600 mt-1">‚Üí {{ node.data.storeInVariable }}</div>
                <div *ngIf="node.data.required" class="text-xs text-red-600 mt-1">
                  <i class="fas fa-asterisk text-xs mr-1"></i>Obligatoire
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- Wait Response -->
              <div *ngSwitchCase="'wait_response'" class="text-center py-2">
                <i class="fas fa-clock text-lg text-teal-600 mb-2"></i>
                <div class="text-xs text-gray-600">Attente r√©ponse ({{ node.data.timeoutSeconds || 300 }}s)</div>
                <div *ngIf="node.data.storeInVariable" class="text-xs text-blue-600 mt-1">‚Üí {{ node.data.storeInVariable }}</div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- Condition avec compte de connexions -->
              <div *ngSwitchCase="'condition'" class="text-center py-2">
                <i class="fas fa-code-branch text-lg text-yellow-600 mb-2"></i>
                <div class="text-xs text-gray-600">
                  {{ node.data.variable || 'Variable' }}
                </div>
                <div class="text-xs text-orange-600 mt-1">{{ node.data.conditionalConnections?.length || 0 }} condition(s)</div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- Variable -->
              <div *ngSwitchCase="'variable_set'" class="text-center py-2">
                <i class="fas fa-database text-lg text-cyan-600 mb-2"></i>
                <div class="text-xs text-gray-600">
                  {{ node.data.variableName || 'Variable' }}
                </div>
                <div class="text-xs text-cyan-600 mt-1">
                  {{ node.data.variableOperation || 'set' }}
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- Image -->
              <div *ngSwitchCase="'image'" class="text-center py-2">
                <i class="fas fa-image text-lg text-pink-600 mb-2"></i>
                <div class="text-xs text-gray-600">
                  {{ node.data.imageUrl ? 'Image configur√©e' : 'Aucune image' }}
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- File -->
              <div *ngSwitchCase="'file'" class="text-center py-2">
                <i class="fas fa-file text-lg text-orange-600 mb-2"></i>
                <div class="text-xs text-gray-600">
                  {{ node.data.fileUrl ? 'Fichier configur√©' : 'Aucun fichier' }}
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- Webhook -->
              <div *ngSwitchCase="'webhook'" class="text-center py-2">
                <i class="fas fa-link text-lg text-red-600 mb-2"></i>
                <div class="text-xs text-gray-600">
                  {{ node.data.webhookUrl ? '3CX configur√©' : 'Non configur√©' }}
                </div>
                <div
                  *ngIf="node.data.waitForUserResponse"
                  class="flex items-center justify-center mt-2 p-1 bg-yellow-100 rounded text-xs text-yellow-800"
                >
                  <i class="fas fa-clock mr-1"></i>
                  Attend r√©ponse
                </div>
              </div>

              <!-- End -->
              <div *ngSwitchCase="'end'" class="text-center py-2">
                <i class="fas fa-stop text-lg text-red-600 mb-2"></i>
                <div class="text-xs text-gray-600">Fin du flow</div>
              </div>
            </div>
          </div>

          <!-- Points de connexion -->
          <div
            *ngIf="node.type !== 'end'"
            class="absolute -right-3 top-1/2 w-6 h-6 bg-blue-500 rounded-full border-2 border-white transform -translate-y-1/2 cursor-pointer hover:bg-blue-600 transition-colors"
            (click)="startConnection(node.id, $event)"
            title="Cr√©er une connexion"
          >
            <i class="fas fa-arrow-right text-white text-xs absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
          </div>

          <div
            *ngIf="node.type !== 'start'"
            class="absolute -left-3 top-1/2 w-6 h-6 bg-green-500 rounded-full border-2 border-white transform -translate-y-1/2 cursor-pointer hover:bg-green-600 transition-colors"
            (click)="finishConnection(node.id, $event)"
            title="Terminer une connexion"
          >
            <i class="fas fa-arrow-left text-white text-xs absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
          </div>
        </div>

        <!-- √âtat vide -->
        <div *ngIf="nodes.length === 0" class="absolute inset-0 flex items-center justify-center">
          <div class="text-center text-gray-500">
            <i class="fas fa-robot text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Cr√©ez votre premier flow</h3>
            <p class="text-gray-400 mb-4">Commencez par ajouter des n≈ìuds depuis la palette</p>
            <button (click)="addNode('message')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
              <i class="fas fa-comment mr-2"></i>Ajouter un message
            </button>
          </div>
        </div>

        <!-- Indicateur de connexion en cours -->
        <div
          *ngIf="isConnecting && connectionStartNodeId"
          class="absolute inset-0 bg-blue-50 bg-opacity-50 flex items-center justify-center pointer-events-none z-20"
        >
          <div class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg">
            <i class="fas fa-link mr-2"></i>
            Cliquez sur un n≈ìud pour cr√©er une connexion
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================ -->
  <!-- PANNEAU PROPRI√âT√âS DROIT -->
  <!-- ================================ -->
  <div *ngIf="selectedNodeId" class="flex flex-col h-full">
    <!-- Header -->
    <div class="p-4 border-b bg-gray-50">
      <h3 class="font-semibold text-lg flex items-center text-gray-800">
        <i class="fas fa-cog mr-2 text-blue-600"></i>
        Propri√©t√©s
      </h3>
      <div *ngIf="getSelectedNode() as node" class="text-sm text-gray-600 mt-1">{{ getNodeLabel(node.type) }} - Ordre {{ node.order }}</div>
    </div>

    <!-- Contenu propri√©t√©s -->
    <div class="flex-1 overflow-y-auto p-4" *ngIf="getSelectedNode() as node">
      <div [ngSwitch]="node.type">
        <!-- ======================== -->
        <!-- START -->
        <!-- ======================== -->
        <div *ngSwitchCase="'whatsapp_form'" class="space-y-4">
          <!-- En-t√™te avec statut du formulaire -->
          <div class="bg-emerald-50 p-3 rounded-lg border border-emerald-200">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center text-emerald-800">
                <i class="fas fa-wpforms mr-2"></i>
                <span class="font-medium">Formulaire WhatsApp</span>
              </div>
              <div class="flex items-center space-x-2">
                <span *ngIf="node.data.isFormPublished" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                  ‚úÖ Publi√©
                </span>
                <button
                  (click)="previewWhatsAppForm(node)"
                  class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full hover:bg-emerald-200"
                >
                  üëÅÔ∏è Aper√ßu
                </button>
                <button
                  (click)="publishWhatsAppForm(node)"
                  [disabled]="!node.data.formTitle"
                  class="text-xs bg-emerald-600 text-white px-3 py-1 rounded-full hover:bg-emerald-700 disabled:opacity-50"
                >
                  üöÄ Publier
                </button>
              </div>
            </div>
            <p class="text-sm text-emerald-700">
              Cr√©√© un formulaire interactif natif dans WhatsApp avec validation et mapping automatique des r√©ponses.
            </p>
          </div>

          <!-- Message d'introduction -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message d'introduction</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
              rows="2"
              placeholder="Veuillez remplir ce formulaire pour continuer..."
            ></textarea>
          </div>

          <!-- Configuration du formulaire -->
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Titre du formulaire *</label>
              <input
                [(ngModel)]="node.data.formTitle"
                (ngModelChange)="onNodeChange()"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                placeholder="Informations de contact"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Sous-titre (optionnel)</label>
              <input
                [(ngModel)]="node.data.formSubtitle"
                (ngModelChange)="onNodeChange()"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                placeholder="Merci de compl√©ter les informations suivantes"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Texte du bouton</label>
              <input
                [(ngModel)]="node.data.ctaText"
                (ngModelChange)="onNodeChange()"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                placeholder="Ouvrir le formulaire"
              />
            </div>
          </div>

          <!-- Image d'en-t√™te (optionnelle) -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Image d'en-t√™te (optionnelle)</label>
            <input
              [(ngModel)]="node.data.formHeaderImage"
              (ngModelChange)="onNodeChange()"
              class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500"
              placeholder="https://example.com/header.jpg"
            />
          </div>

          <!-- Templates de formulaires -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Templates rapides</label>
            <div class="grid grid-cols-2 gap-2">
              <button (click)="applyFormTemplate(node, 'contact')" class="p-2 bg-blue-50 text-blue-700 rounded text-xs hover:bg-blue-100">
                üìû Contact
              </button>
              <button
                (click)="applyFormTemplate(node, 'feedback')"
                class="p-2 bg-green-50 text-green-700 rounded text-xs hover:bg-green-100"
              >
                ‚≠ê Feedback
              </button>
              <button
                (click)="applyFormTemplate(node, 'registration')"
                class="p-2 bg-purple-50 text-purple-700 rounded text-xs hover:bg-purple-100"
              >
                üìù Inscription
              </button>
              <button
                (click)="applyFormTemplate(node, 'survey')"
                class="p-2 bg-orange-50 text-orange-700 rounded text-xs hover:bg-orange-100"
              >
                üìä Enqu√™te
              </button>
            </div>
          </div>

          <!-- Champs du formulaire -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">
              Champs du formulaire ({{ getEnabledFormFieldsCount(node) }} actifs)
            </label>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              <div
                *ngFor="let field of node.data.formFields; let i = index"
                class="p-3 border rounded-lg"
                [class]="field.enabled ? 'bg-emerald-50 border-emerald-200' : 'bg-gray-50 border-gray-200'"
              >
                <!-- En-t√™te du champ -->
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center space-x-2">
                    <input type="checkbox" [(ngModel)]="field.enabled" (ngModelChange)="onNodeChange()" class="rounded" />
                    <span class="font-medium text-sm">Champ {{ i + 1 }}</span>
                    <span
                      class="text-xs px-2 py-1 rounded-full"
                      [class]="field.required ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'"
                    >
                      {{ field.required ? 'Obligatoire' : 'Optionnel' }}
                    </span>
                  </div>
                  <button (click)="removeFormField(node, i)" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>

                <!-- Configuration du champ -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                  <select
                    [(ngModel)]="field.type"
                    (ngModelChange)="onFormFieldTypeChange(field); onNodeChange()"
                    class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-emerald-500"
                  >
                    <option value="text">üìù Texte</option>
                    <option value="email">üìß Email</option>
                    <option value="phone">üìû T√©l√©phone</option>
                    <option value="number">üî¢ Nombre</option>
                    <option value="date">üìÖ Date</option>
                    <option value="time">‚è∞ Heure</option>
                    <option value="textarea">üìÑ Zone de texte</option>
                    <option value="dropdown">üìã Liste d√©roulante</option>
                    <option value="radio">üîò Boutons radio</option>
                    <option value="checkbox">‚òëÔ∏è Cases √† cocher</option>
                  </select>

                  <div class="flex items-center space-x-2">
                    <input type="checkbox" [(ngModel)]="field.required" (ngModelChange)="onNodeChange()" class="rounded" />
                    <label class="text-sm text-gray-700">Obligatoire</label>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-2">
                  <input
                    [(ngModel)]="field.name"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-emerald-500"
                    placeholder="nom_du_champ"
                  />
                  <input
                    [(ngModel)]="field.label"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-emerald-500"
                    placeholder="Label affich√©"
                  />
                </div>

                <input
                  [(ngModel)]="field.placeholder"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 border border-gray-300 rounded text-sm mb-2 focus:ring-2 focus:ring-emerald-500"
                  placeholder="Texte d'aide (placeholder)"
                />

                <!-- Options pour dropdown, radio, checkbox -->
                <div *ngIf="field.type === 'dropdown' || field.type === 'radio' || field.type === 'checkbox'" class="mt-2">
                  <label class="block text-xs font-medium mb-1 text-gray-600">Options</label>
                  <div class="space-y-1">
                    <div *ngFor="let option of field.options; let j = index" class="flex items-center space-x-2">
                      <input
                        [(ngModel)]="option.title"
                        (ngModelChange)="onNodeChange()"
                        class="flex-1 p-1 border border-gray-300 rounded text-xs"
                        placeholder="Titre de l'option"
                      />
                      <input
                        [(ngModel)]="option.value"
                        (ngModelChange)="onNodeChange()"
                        class="flex-1 p-1 border border-gray-300 rounded text-xs"
                        placeholder="Valeur"
                      />
                      <button (click)="removeFieldOption(field, j)" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times text-xs"></i>
                      </button>
                    </div>
                    <button
                      (click)="addFieldOption(field)"
                      class="w-full p-1 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-emerald-300 text-xs"
                    >
                      <i class="fas fa-plus mr-1"></i> Ajouter option
                    </button>
                  </div>
                </div>

                <!-- Validation avanc√©e -->
                <div *ngIf="field.type === 'text' || field.type === 'textarea'" class="mt-2">
                  <details class="text-xs">
                    <summary class="cursor-pointer text-gray-600">Validation avanc√©e</summary>
                    <div *ngIf="field.validation" class="mt-2 grid grid-cols-2 gap-2">
                      <input
                        type="number"
                        [(ngModel)]="field.validation.minLength"
                        (ngModelChange)="onNodeChange()"
                        class="p-1 border border-gray-300 rounded text-xs"
                        placeholder="Min caract√®res"
                      />

                      <input
                        type="number"
                        [(ngModel)]="field.validation.maxLength"
                        (ngModelChange)="onNodeChange()"
                        class="p-1 border border-gray-300 rounded text-xs"
                        placeholder="Max caract√®res"
                      />
                    </div>
                    <div *ngIf="field.validation">
                      <input
                        [(ngModel)]="field.validation.errorMessage"
                        (ngModelChange)="onNodeChange()"
                        class="w-full p-1 border border-gray-300 rounded text-xs mt-1"
                        placeholder="Message d'erreur personnalis√©"
                      />
                    </div>
                  </details>
                </div>
              </div>

              <!-- Bouton ajouter champ -->
              <button
                (click)="addFormField(node)"
                class="w-full p-3 border-2 border-dashed border-emerald-300 rounded-lg text-emerald-600 hover:border-emerald-400 hover:text-emerald-700"
              >
                <i class="fas fa-plus mr-2"></i> Ajouter un champ
              </button>
            </div>
          </div>

          <!-- Mapping des r√©ponses -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700"> Mapping des r√©ponses vers les variables </label>
            <div class="space-y-2">
              <div
                *ngFor="let mapping of node.data.formResponseMapping; let i = index"
                class="flex items-center space-x-2 p-2 bg-blue-50 rounded border border-blue-200"
              >
                <input type="checkbox" [(ngModel)]="mapping.enabled" (ngModelChange)="onNodeChange()" class="rounded" />
                <select
                  [(ngModel)]="mapping.fieldName"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                >
                  <option value="">Champ du formulaire...</option>
                  <option *ngFor="let field of getEnabledFormFields(node)" [value]="field.name">
                    {{ field.label }} ({{ field.name }})
                  </option>
                </select>
                <span class="text-gray-500">‚Üí</span>
                <input
                  [(ngModel)]="mapping.variableName"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                  placeholder="nom_variable"
                />
                <button (click)="removeFormMapping(node, i)" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>

              <button
                (click)="addFormMapping(node)"
                class="w-full p-2 border-2 border-dashed border-blue-300 rounded text-blue-600 hover:border-blue-400 text-sm"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter mapping
              </button>
            </div>
          </div>

          <!-- Messages de feedback -->
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Message de succ√®s</label>
              <input
                [(ngModel)]="node.data.successMessage"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500"
                placeholder="‚úÖ Formulaire envoy√© avec succ√®s !"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Message d'erreur</label>
              <input
                [(ngModel)]="node.data.errorMessage"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500"
                placeholder="‚ùå Erreur lors de l'envoi. Veuillez r√©essayer."
              />
            </div>
          </div>

          <!-- N≈ìuds suivants conditionnels -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Si succ√®s, aller au n≈ìud</label>
              <select
                [(ngModel)]="node.data.formSuccessNextNodeId"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-emerald-500"
              >
                <option value="">N≈ìud suivant par d√©faut</option>
                <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                  {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                </option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Si erreur, aller au n≈ìud</label>
              <select
                [(ngModel)]="node.data.formErrorNextNodeId"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-emerald-500"
              >
                <option value="">N≈ìud suivant par d√©faut</option>
                <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                  {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                </option>
              </select>
            </div>
          </div>

          <!-- Derni√®re soumission (debug) -->
          <div
            *ngIf="node.data.lastFormSubmission"
            class="mt-4 p-3 rounded-lg"
            [class]="node.data.lastFormSubmission.isValid ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium" [class]="node.data.lastFormSubmission.isValid ? 'text-green-800' : 'text-red-800'">
                <i [class]="node.data.lastFormSubmission.isValid ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                Derni√®re soumission: {{ node.data.lastFormSubmission.isValid ? 'Valid√©e' : 'Erreur' }}
              </span>
              <span class="text-xs text-gray-600">
                {{ formatDateTime(node.data.lastFormSubmission.submissionTime) }}
              </span>
            </div>

            <div class="text-sm">
              <div *ngIf="node.data.lastFormSubmission.validationErrors?.length">
                <strong>Erreurs:</strong>
                <ul class="list-disc list-inside">
                  <li *ngFor="let error of node.data.lastFormSubmission.validationErrors">{{ error }}</li>
                </ul>
              </div>
              <div *ngIf="node.data.lastFormSubmission.userResponses">
                <strong>R√©ponses:</strong>
                <pre class="mt-1 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-32">{{
                  formatJsonResponse(node.data.lastFormSubmission.userResponses)
                }}</pre>
              </div>
            </div>
          </div>

          <!-- N≈ìud suivant par d√©faut -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant par d√©faut</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>

          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>
        <div *ngSwitchCase="'api_connector'" class="space-y-4">
          <!-- En-t√™te avec statut de l'API -->
          <div class="bg-violet-50 p-3 rounded-lg border border-violet-200">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center text-violet-800">
                <i class="fas fa-cloud mr-2"></i>
                <span class="font-medium">Connecteur API</span>
              </div>
              <div class="flex items-center space-x-2">
                <span *ngIf="node.data.isApiValid" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full"> ‚úÖ API test√©e </span>
                <button
                  (click)="testApiCall(node)"
                  [disabled]="!node.data.apiUrl"
                  class="text-xs bg-violet-100 text-violet-700 px-3 py-1 rounded-full hover:bg-violet-200 disabled:opacity-50"
                >
                  üß™ Tester
                </button>
              </div>
            </div>
            <p class="text-sm text-violet-700">
              Effectue des appels API REST avec gestion compl√®te des r√©ponses et mapping vers les variables.
            </p>
          </div>

          <!-- Configuration de base -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">M√©thode HTTP</label>
              <select
                [(ngModel)]="node.data.apiMethod"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-violet-500 focus:border-transparent"
              >
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
                <option value="PATCH">PATCH</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Timeout (ms)</label>
              <input
                type="number"
                [(ngModel)]="node.data.timeout"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-violet-500 focus:border-transparent"
                placeholder="10000"
                min="1000"
                max="60000"
              />
            </div>
          </div>

          <!-- URL de l'API -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">
              URL de l'API
              <span class="text-xs text-gray-500">(utilisez &#123;variable&#125; pour les variables)</span>
            </label>
            <input
              [(ngModel)]="node.data.apiUrl"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent"
              placeholder="https://api.example.com/users/{user_id}"
            />
          </div>

          <!-- Authentification -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">Authentification</label>
            <div class="space-y-3">
              <select
                [(ngModel)]="node.data.authType"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-violet-500 focus:border-transparent"
              >
                <option value="none">Aucune</option>
                <option value="bearer">Bearer Token</option>
                <option value="basic">Basic Auth</option>
                <option value="api_key">API Key</option>
              </select>

              <!-- Bearer Token -->
              <div *ngIf="node.data.authType === 'bearer'">
                <input
                  [(ngModel)]="node.data.authToken"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
                  placeholder="Token d'authentification ou {token_variable}"
                />
              </div>

              <!-- Basic Auth -->
              <div *ngIf="node.data.authType === 'basic'" class="grid grid-cols-2 gap-2">
                <input
                  [(ngModel)]="node.data.authUsername"
                  (ngModelChange)="onNodeChange()"
                  class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
                  placeholder="Nom d'utilisateur"
                />
                <input
                  type="password"
                  [(ngModel)]="node.data.authPassword"
                  (ngModelChange)="onNodeChange()"
                  class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
                  placeholder="Mot de passe"
                />
              </div>

              <!-- API Key -->
              <div *ngIf="node.data.authType === 'api_key'" class="grid grid-cols-2 gap-2">
                <input
                  [(ngModel)]="node.data.authApiKeyHeader"
                  (ngModelChange)="onNodeChange()"
                  class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
                  placeholder="Nom du header (ex: X-API-Key)"
                />
                <input
                  [(ngModel)]="node.data.authApiKey"
                  (ngModelChange)="onNodeChange()"
                  class="p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
                  placeholder="Cl√© API ou {api_key_variable}"
                />
              </div>
            </div>
          </div>

          <!-- Headers personnalis√©s -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">Headers HTTP</label>
            <div class="space-y-2">
              <div
                *ngFor="let header of node.data.apiHeaders; let i = index"
                class="flex items-center space-x-2 p-2 bg-gray-50 rounded border"
              >
                <input type="checkbox" [(ngModel)]="header.enabled" (ngModelChange)="onNodeChange()" class="rounded" />
                <input
                  [(ngModel)]="header.key"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                  placeholder="Header"
                />
                <input
                  [(ngModel)]="header.value"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                  placeholder="Valeur"
                />
                <button (click)="removeApiHeader(node, i)" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>

              <button
                (click)="addApiHeader(node)"
                class="w-full p-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-violet-300 hover:text-violet-600 text-sm"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter header
              </button>
            </div>
          </div>

          <!-- Param√®tres -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">Param√®tres</label>
            <div class="space-y-2">
              <div
                *ngFor="let param of node.data.apiParameters; let i = index"
                class="flex items-center space-x-2 p-2 bg-gray-50 rounded border"
              >
                <input type="checkbox" [(ngModel)]="param.enabled" (ngModelChange)="onNodeChange()" class="rounded" />
                <select [(ngModel)]="param.type" (ngModelChange)="onNodeChange()" class="p-1 border border-gray-300 rounded text-sm">
                  <option value="query">Query</option>
                  <option value="body">Body</option>
                  <option value="path">Path</option>
                </select>
                <input
                  [(ngModel)]="param.key"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                  placeholder="Nom"
                />
                <input
                  [(ngModel)]="param.value"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                  placeholder="Valeur ou {variable}"
                />
                <button (click)="removeApiParameter(node, i)" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>

              <button
                (click)="addApiParameter(node)"
                class="w-full p-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-violet-300 hover:text-violet-600 text-sm"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter param√®tre
              </button>
            </div>
          </div>

          <!-- Corps de la requ√™te (pour POST/PUT/PATCH) -->
          <div *ngIf="node.data.apiMethod !== 'GET' && node.data.apiMethod !== 'DELETE'">
            <label class="block text-sm font-medium mb-1 text-gray-700">Corps de la requ√™te</label>
            <div class="space-y-2">
              <select
                [(ngModel)]="node.data.requestBodyType"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
              >
                <option value="json">JSON</option>
                <option value="form">Form Data</option>
                <option value="text">Texte brut</option>
                <option value="xml">XML</option>
              </select>

              <textarea
                [(ngModel)]="node.data.requestBody"
                (ngModelChange)="onNodeChange()"
                class="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-violet-500"
                rows="4"
                [placeholder]="getRequestBodyPlaceholder(node.data.requestBodyType)"
              ></textarea>
            </div>
          </div>

          <!-- Mapping des r√©ponses -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">
              Mapping des r√©ponses
              <span class="text-xs text-gray-500">(extraire des donn√©es de la r√©ponse vers les variables)</span>
            </label>
            <div class="space-y-2">
              <div
                *ngFor="let mapping of node.data.responseMapping; let i = index"
                class="flex items-center space-x-2 p-2 bg-blue-50 rounded border border-blue-200"
              >
                <input type="checkbox" [(ngModel)]="mapping.enabled" (ngModelChange)="onNodeChange()" class="rounded" />
                <input
                  [(ngModel)]="mapping.jsonPath"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm font-mono"
                  placeholder="data.user.name"
                />
                <span class="text-gray-500">‚Üí</span>
                <input
                  [(ngModel)]="mapping.variableName"
                  (ngModelChange)="onNodeChange()"
                  class="flex-1 p-1 border border-gray-300 rounded text-sm"
                  placeholder="user_name"
                />
                <button (click)="removeResponseMapping(node, i)" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>

              <button
                (click)="addResponseMapping(node)"
                class="w-full p-2 border-2 border-dashed border-blue-300 rounded text-blue-600 hover:border-blue-400 hover:text-blue-700 text-sm"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter mapping
              </button>
            </div>
          </div>

          <!-- Gestion des erreurs -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">En cas d'erreur</label>
              <select
                [(ngModel)]="node.data.errorHandling"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
              >
                <option value="continue">Continuer le flow</option>
                <option value="stop">Arr√™ter le flow</option>
                <option value="retry">R√©essayer</option>
              </select>
            </div>

            <div *ngIf="node.data.errorHandling === 'retry'">
              <label class="block text-sm font-medium mb-1 text-gray-700">Nb de tentatives</label>
              <input
                type="number"
                [(ngModel)]="node.data.retryCount"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
                min="1"
                max="5"
                placeholder="3"
              />
            </div>
          </div>

          <!-- Condition de succ√®s personnalis√©e -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">
              Condition de succ√®s
              <span class="text-xs text-gray-500">(laisser vide pour: status >= 200 && status < 300)</span>
            </label>
            <input
              [(ngModel)]="node.data.successCondition"
              (ngModelChange)="onNodeChange()"
              class="w-full p-2 border border-gray-300 rounded text-sm font-mono focus:ring-2 focus:ring-violet-500"
              placeholder="status === 200 && responseTime < 5000"
            />
            <p class="text-xs text-gray-500 mt-1">Variables disponibles: <code>status</code>, <code>responseTime</code></p>
          </div>

          <!-- N≈ìuds suivants conditionnels -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Si succ√®s, aller au n≈ìud</label>
              <select
                [(ngModel)]="node.data.successNextNodeId"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
              >
                <option value="">N≈ìud suivant par d√©faut</option>
                <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                  {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                </option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Si erreur, aller au n≈ìud</label>
              <select
                [(ngModel)]="node.data.errorNextNodeId"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-violet-500"
              >
                <option value="">N≈ìud suivant par d√©faut</option>
                <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                  {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                </option>
              </select>
            </div>
          </div>

          <!-- Message pendant l'appel API -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message pendant l'appel API (optionnel)</label>
            <input
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-violet-500"
              placeholder="Traitement en cours, veuillez patienter..."
            />
          </div>

          <!-- R√©sultat du dernier test -->
          <div
            *ngIf="node.data.lastTestResult"
            class="mt-4 p-3 rounded-lg"
            [class]="node.data.lastTestResult.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium" [class]="node.data.lastTestResult.success ? 'text-green-800' : 'text-red-800'">
                <i [class]="node.data.lastTestResult.success ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                Dernier test: {{ node.data.lastTestResult.success ? 'Succ√®s' : '√âchec' }}
              </span>
              <span class="text-xs text-gray-600"> {{ node.data.lastTestResult.responseTime }}ms </span>
            </div>

            <div class="text-sm space-y-1">
              <div><strong>Statut:</strong> {{ node.data.lastTestResult.status }} {{ node.data.lastTestResult.statusText }}</div>
              <div *ngIf="node.data.lastTestResult.error"><strong>Erreur:</strong> {{ node.data.lastTestResult.error }}</div>
              <div *ngIf="node.data.lastTestResult.responseData">
                <strong>R√©ponse:</strong>
                <pre class="mt-1 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-32">{{
                  formatJsonResponse(node.data.lastTestResult.responseData)
                }}</pre>
              </div>
            </div>
          </div>

          <!-- N≈ìud suivant par d√©faut -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant par d√©faut</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>

          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>
        <div *ngSwitchCase="'start'" class="space-y-4">
          <div class="bg-green-50 p-3 rounded-lg border border-green-200">
            <div class="flex items-center text-green-800 mb-2">
              <i class="fas fa-play mr-2"></i>
              <span class="font-medium">N≈ìud de d√©marrage</span>
            </div>
            <p class="text-sm text-green-700">Point d'entr√©e du flow. Ce n≈ìud ne peut pas √™tre supprim√©.</p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner le premier n≈ìud...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
        </div>

        <!-- ======================== -->
        <!-- MESSAGE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'message'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="4"
              placeholder="Votre message..."
            ></textarea>
          </div>

          <div class="flex items-center space-x-2">
            <input type="checkbox" [(ngModel)]="node.data.useVariables" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">Utiliser des variables (ex: &#123;nom_utilisateur&#125;)</label>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- BOUTONS -->
        <!-- ======================== -->
        <div *ngSwitchCase="'buttons'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="Choisissez une option:"
            ></textarea>
          </div>

          <!-- Variable de stockage globale -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Stocker la r√©ponse dans</label>
            <select
              [(ngModel)]="node.data.storeInVariable"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Aucune variable</option>
              <option *ngFor="let variable of flowConfig.variables" [value]="variable.name">
                {{ variable.name }}
              </option>
            </select>
          </div>

          <!-- Boutons avec connexions -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">Boutons et connexions</label>
            <div class="space-y-3">
              <div *ngFor="let button of node.data.buttons; let i = index" class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <!-- Configuration bouton -->
                <div class="grid grid-cols-2 gap-2 mb-3">
                  <input
                    [(ngModel)]="button.text"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Texte du bouton"
                  />
                  <input
                    [(ngModel)]="button.value"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Valeur stock√©e"
                  />
                </div>

                <!-- Connexion directe -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Quand ce bouton est cliqu√© :</span>
                    <button
                      (click)="removeButton(node, i)"
                      class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors text-sm"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>

                  <select
                    [(ngModel)]="button.nextNodeId"
                    (ngModelChange)="onNodeChange()"
                    class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">Aller au n≈ìud...</option>
                    <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                      {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                    </option>
                  </select>
                </div>
              </div>

              <button
                (click)="addButton(node)"
                class="w-full p-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-blue-300 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter bouton
              </button>
            </div>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- LISTE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'list'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="S√©lectionnez dans la liste:"
            ></textarea>
          </div>

          <!-- Variable de stockage -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Stocker la s√©lection dans</label>
            <select
              [(ngModel)]="node.data.storeInVariable"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Aucune variable</option>
              <option *ngFor="let variable of flowConfig.variables" [value]="variable.name">
                {{ variable.name }}
              </option>
            </select>
          </div>

          <!-- Options avec connexions -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">Options et connexions</label>
            <div class="space-y-3">
              <div *ngFor="let item of node.data.items; let i = index" class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <!-- Configuration option -->
                <div class="grid grid-cols-2 gap-2 mb-3">
                  <input
                    [(ngModel)]="item.title"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Titre de l'option"
                  />
                  <input
                    [(ngModel)]="item.value"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Valeur stock√©e"
                  />
                </div>

                <!-- Description optionnelle -->
                <input
                  [(ngModel)]="item.description"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 border border-gray-300 rounded text-sm mb-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Description (optionnelle)"
                />

                <!-- Connexion -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Quand cette option est s√©lectionn√©e :</span>
                    <button
                      (click)="removeListItem(node, i)"
                      class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors text-sm"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>

                  <select
                    [(ngModel)]="item.nextNodeId"
                    (ngModelChange)="onNodeChange()"
                    class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">Aller au n≈ìud...</option>
                    <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                      {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                    </option>
                  </select>
                </div>
              </div>

              <button
                (click)="addListItem(node)"
                class="w-full p-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-blue-300 hover:text-blue-600 transition-colors"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter option
              </button>
            </div>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- INPUT -->
        <!-- ======================== -->
        <div *ngSwitchCase="'input'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Question √† poser</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="Veuillez saisir votre nom:"
            ></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Type de r√©ponse</label>
              <select
                [(ngModel)]="node.data.responseType"
                (ngModelChange)="onNodeChange(); onResponseTypeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="text">üìù Texte libre</option>
                <option value="number">üî¢ Nombre</option>
                <option value="email">üìß Email</option>
                <option value="phone">üìû T√©l√©phone</option>
                <option value="url">üîó URL/Lien</option>
                <option value="date">üìÖ Date</option>
                <option value="time">‚è∞ Heure</option>
                <option value="file">üìé Fichier (tout type)</option>
                <option value="image">üñºÔ∏è Image uniquement</option>
                <option value="document">üìÑ Document (PDF, Word, etc.)</option>
                <option value="audio">üéµ Audio/Vocal</option>
                <option value="video">üé¨ Vid√©o</option>
                <option value="location">üìç Localisation</option>
                <option value="contact">üë§ Contact</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Stocker dans</label>
              <select
                [(ngModel)]="node.data.storeInVariable"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Nouvelle variable...</option>
                <option *ngFor="let variable of flowConfig.variables" [value]="variable.name">
                  {{ variable.name }}
                </option>
              </select>
            </div>
          </div>

          <!-- Messages d'aide dynamiques selon le type -->
          <div *ngIf="node.data.responseType" class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-start space-x-2">
              <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
              <div class="text-sm text-blue-800">
                <p class="font-medium mb-1">{{ getResponseTypeTitle(node.data.responseType) }}</p>
                <p>{{ getResponseTypeDescription(node.data.responseType) }}</p>
                <p *ngIf="getResponseTypeExample(node.data.responseType)" class="mt-1 font-mono text-xs bg-blue-100 px-2 py-1 rounded">
                  Exemple: {{ getResponseTypeExample(node.data.responseType) }}
                </p>
              </div>
            </div>
          </div>

          <!-- Configuration avanc√©e pour certains types -->
          <div *ngIf="needsAdvancedConfig(node.data.responseType)" class="space-y-3 p-3 bg-gray-50 rounded-lg">
            <h4 class="font-medium text-gray-800">Configuration avanc√©e</h4>

            <!-- Validation min/max pour nombres -->
            <div *ngIf="node.data.responseType === 'number'" class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600">Valeur minimum</label>
                <input
                  type="number"
                  [(ngModel)]="node.data.minValue"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                  placeholder="0"
                />
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600">Valeur maximum</label>
                <input
                  type="number"
                  [(ngModel)]="node.data.maxValue"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                  placeholder="100"
                />
              </div>
            </div>

            <!-- Validation longueur pour texte -->
            <div *ngIf="node.data.responseType === 'text'" class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600">Longueur minimum</label>
                <input
                  type="number"
                  [(ngModel)]="node.data.minLength"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                  placeholder="0"
                />
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600">Longueur maximum</label>
                <input
                  type="number"
                  [(ngModel)]="node.data.maxLength"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                  placeholder="500"
                />
              </div>
            </div>

            <!-- Taille max pour fichiers -->
            <div *ngIf="isFileType(node.data.responseType)" class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600">Taille max (MB)</label>
                <input
                  type="number"
                  [(ngModel)]="node.data.maxFileSize"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                  placeholder="10"
                  min="0.1"
                  max="100"
                  step="0.1"
                />
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600">Extensions autoris√©es</label>
                <input
                  type="text"
                  [(ngModel)]="node.data.allowedExtensions"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                  placeholder="jpg,png,pdf"
                />
              </div>
            </div>
          </div>

          <div class="flex items-center space-x-2">
            <input type="checkbox" [(ngModel)]="node.data.required" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">R√©ponse obligatoire</label>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message si validation √©choue</label>
            <input
              [(ngModel)]="node.data.validationMessage"
              (ngModelChange)="onNodeChange()"
              class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              [placeholder]="getDefaultValidationMessage(node.data.responseType)"
            />
            <p class="text-xs text-gray-500 mt-1">Message affich√© si l'utilisateur envoie un type de contenu incorrect</p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>

          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- WAIT_RESPONSE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'wait_response'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message d'attente</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="J'attends votre r√©ponse..."
            ></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Timeout (secondes)</label>
              <input
                type="number"
                [(ngModel)]="node.data.timeoutSeconds"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="300"
                min="30"
                max="3600"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">Stocker dans</label>
              <select
                [(ngModel)]="node.data.storeInVariable"
                (ngModelChange)="onNodeChange()"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Nouvelle variable...</option>
                <option *ngFor="let variable of flowConfig.variables" [value]="variable.name">
                  {{ variable.name }}
                </option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- CONDITION AVANC√âE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'condition'" class="space-y-4">
          <!-- Type de condition -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Type de condition</label>
            <select
              [(ngModel)]="node.data.conditionType"
              (ngModelChange)="onConditionTypeChange(node)"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="variable_value">Valeur d'une variable</option>
              <option value="user_response">R√©ponse de l'utilisateur</option>
            </select>
          </div>

          <!-- Configuration selon le type -->
          <div *ngIf="node.data.conditionType === 'variable_value'">
            <label class="block text-sm font-medium mb-1 text-gray-700">Variable √† tester</label>
            <select
              [(ngModel)]="node.data.variable"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner variable...</option>
              <option *ngFor="let variable of flowConfig.variables" [value]="variable.name">
                {{ variable.name }}
              </option>
            </select>
          </div>

          <!-- Connexions conditionnelles multiples -->
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-700">Conditions et connexions</label>
            <div class="space-y-3">
              <div
                *ngFor="let conn of node.data.conditionalConnections; let i = index"
                class="p-3 bg-blue-50 rounded-lg border border-blue-200"
              >
                <!-- Dans le cas 'condition' -->
                <div class="grid grid-cols-3 gap-2 mb-2">
                  <select [(ngModel)]="conn.operator" (ngModelChange)="onNodeChange()" class="p-2 border border-gray-300 rounded text-sm">
                    <option value="equals">Est √©gal √†</option>
                    <option value="contains">Contient</option>
                    <option value="starts_with">Commence par</option>
                    <option value="custom_expression">Expression custom</option>
                    <!-- ‚Üê NOUVEAU -->
                  </select>

                  <!-- Champ condition normal -->
                  <input
                    *ngIf="conn.operator !== 'custom_expression'"
                    [(ngModel)]="conn.condition"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded text-sm"
                    placeholder="Valeur √† tester"
                  />

                  <!-- Champ expression custom -->
                  <input
                    *ngIf="conn.operator === 'custom_expression'"
                    [(ngModel)]="conn.condition"
                    (ngModelChange)="onNodeChange()"
                    class="p-2 border border-gray-300 rounded text-sm col-span-1"
                    placeholder="result contains 'x' and result is text"
                  />

                  <button
                    (click)="removeConditionalConnection(node, i)"
                    class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors text-sm"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>

                <!-- Aide pour les expressions custom -->
                <div *ngIf="conn.operator === 'custom_expression'" class="text-xs text-gray-500 mt-1 p-2 bg-blue-50 rounded">
                  <strong>Exemples :</strong><br />
                  ‚Ä¢ <code>result contains 'oui'</code><br />
                  ‚Ä¢ <code>result is number</code><br />
                  ‚Ä¢ <code>result contains 'x' or result contains 'y'</code><br />
                  ‚Ä¢ <code>result contains 'email' and result is text</code>
                </div>

                <select
                  [(ngModel)]="conn.nextNodeId"
                  (ngModelChange)="onNodeChange()"
                  class="w-full p-2 border border-gray-300 rounded text-sm"
                >
                  <option value="">Alors aller au n≈ìud...</option>
                  <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                    {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
                  </option>
                </select>
              </div>

              <button
                (click)="addConditionalConnection(node)"
                class="w-full p-2 border-2 border-dashed border-blue-300 rounded text-blue-600 hover:border-blue-400 transition-colors"
              >
                <i class="fas fa-plus mr-1"></i> Ajouter condition
              </button>
            </div>
          </div>

          <!-- N≈ìud par d√©faut -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Sinon, aller au n≈ìud (par d√©faut)</label>
            <select
              [(ngModel)]="node.data.defaultNextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Aucun (fin du flow)</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- VARIABLE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'variable_set'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Variable</label>
            <select
              [(ngModel)]="node.data.variableName"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner variable...</option>
              <option *ngFor="let variable of flowConfig.variables" [value]="variable.name">
                {{ variable.name }}
              </option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Op√©ration</label>
            <select
              [(ngModel)]="node.data.variableOperation"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="set">D√©finir valeur</option>
              <option value="increment">Incr√©menter (+1)</option>
              <option value="decrement">D√©cr√©menter (-1)</option>
            </select>
          </div>

          <div *ngIf="node.data.variableOperation === 'set'">
            <label class="block text-sm font-medium mb-1 text-gray-700">Valeur</label>
            <input
              [(ngModel)]="node.data.variableValue"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Nouvelle valeur"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- IMAGE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'image'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">URL de l'image</label>
            <input
              [(ngModel)]="node.data.imageUrl"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="https://example.com/image.jpg"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Ou uploader une image</label>
            <input
              type="file"
              accept="image/*"
              (change)="onImageUpload($event, node)"
              class="w-full p-2 border border-gray-300 rounded-lg text-sm"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">L√©gende (optionnelle)</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="L√©gende de l'image..."
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- FILE -->
        <!-- ======================== -->
        <div *ngSwitchCase="'file'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">URL du fichier</label>
            <input
              [(ngModel)]="node.data.fileUrl"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="https://example.com/document.pdf"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Nom du fichier</label>
            <input
              [(ngModel)]="node.data.fileName"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="document.pdf"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Ou uploader un fichier</label>
            <input type="file" (change)="onFileUpload($event, node)" class="w-full p-2 border border-gray-300 rounded-lg text-sm" />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message d'accompagnement</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="Voici le document demand√©..."
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">S√©lectionner...</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- WEBHOOK 3CX -->
        <!-- ======================== -->
        <div *ngSwitchCase="'webhook'" class="space-y-4">
          <div class="bg-red-50 p-3 rounded-lg border border-red-200">
            <div class="flex items-center text-red-800 mb-2">
              <i class="fas fa-info-circle mr-2"></i>
              <span class="font-medium">Configuration 3CX</span>
            </div>
            <p class="text-sm text-red-700">Ce n≈ìud transfert les donn√©es vers votre syst√®me 3CX pour la gestion d'agents.</p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">URL du webhook 3CX</label>
            <input
              [(ngModel)]="node.data.webhookUrl"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="https://your-3cx-server.com/webhook/transfer"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">M√©thode HTTP</label>
            <select
              [(ngModel)]="node.data.method"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="POST">POST</option>
              <option value="GET">GET</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message avant transfert</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="Je vous transf√®re vers un agent..."
            ></textarea>
          </div>

          <div class="space-y-2">
            <button
              (click)="testWebhook(node)"
              [disabled]="!node.data.webhookUrl"
              class="w-full p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <i class="fas fa-flask mr-2"></i>Tester le webhook
            </button>

            <div class="text-xs text-gray-500"><strong>Donn√©es envoy√©es :</strong> partnerId, userPhone, variables du flow, message</div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">N≈ìud suivant (optionnel)</label>
            <select
              [(ngModel)]="node.nextNodeId"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Fin du flow (recommand√©)</option>
              <option *ngFor="let n of getAvailableNodes(node.id)" [value]="n.id">
                {{ getNodeLabel(n.type) }} ({{ n.order }}) - {{ n.label || 'Sans titre' }}
              </option>
            </select>
          </div>
          <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
            <input type="checkbox" [(ngModel)]="node.data.waitForUserResponse" (ngModelChange)="onNodeChange()" class="rounded" />
            <label class="text-sm text-gray-700">
              <i class="fas fa-clock mr-1 text-blue-600"></i>
              Attendre une r√©ponse utilisateur
            </label>
          </div>
        </div>

        <!-- ======================== -->
        <!-- END -->
        <!-- ======================== -->
        <div *ngSwitchCase="'end'" class="space-y-4">
          <div class="bg-gray-50 p-3 rounded-lg border">
            <div class="flex items-center text-gray-800 mb-2">
              <i class="fas fa-stop mr-2"></i>
              <span class="font-medium">Fin du flow</span>
            </div>
            <p class="text-sm text-gray-600">Ce n≈ìud termine le flow. L'utilisateur ne recevra plus de messages automatiques.</p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Message de fin</label>
            <textarea
              [(ngModel)]="node.data.text"
              (ngModelChange)="onNodeChange()"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="Merci pour votre visite !"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- ======================== -->
      <!-- ACTIONS DU N≈íUD -->
      <!-- ======================== -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <h4 class="font-medium text-gray-800 mb-3">Actions</h4>
        <div class="space-y-2">
          <button
            (click)="duplicateNode(node.id)"
            class="w-full p-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm"
          >
            <i class="fas fa-copy mr-2"></i>Dupliquer ce n≈ìud
          </button>

          <button
            *ngIf="node.type !== 'start'"
            (click)="deleteNode(node.id)"
            class="w-full p-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors text-sm"
          >
            <i class="fas fa-trash mr-2"></i>Supprimer ce n≈ìud
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================================ -->
<!-- LOADING OVERLAY -->
<!-- ================================ -->
<div *ngIf="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
    <div class="flex items-center space-x-3">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
      <span class="text-gray-700">Chargement...</span>
    </div>
  </div>
</div>
<!-- Ajoutez ce modal √† la fin de votre template HTML, juste avant la fermeture de la div principale -->

<!-- ================================ -->
<!-- MODAL DE TEST DU CHATBOT -->
<!-- ================================ -->
<div *ngIf="isTestModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col overflow-hidden">
    <!-- Header du modal -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
          <i class="fas fa-robot"></i>
        </div>
        <div>
          <h3 class="font-semibold text-lg">Test du Flow: {{ flowConfig.name }}</h3>
          <p class="text-blue-100 text-sm" *ngIf="testSession">
            Session: {{ testSession.id }} ‚Ä¢ {{ formatTestTime(testSession.startTime) }}
          </p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <button
          (click)="restartTest()"
          class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors"
          title="Red√©marrer le test"
        >
          <i class="fas fa-redo text-sm"></i>
        </button>
        <button
          (click)="closeTestModal()"
          class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors"
          title="Fermer le test"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Barre de statut -->
    <div class="bg-gray-50 border-b px-4 py-2 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-600">Test actif</span>
        </div>

        <div class="text-sm text-gray-500" *ngIf="currentTestNode">
          N≈ìud actuel: {{ getNodeLabel(currentTestNode.type) }} ({{ currentTestNode.order }})
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <i class="fas fa-check-circle text-green-500 text-sm"></i>
        <span class="text-sm text-gray-600">{{ nodes.length }} n≈ìuds charg√©s</span>
      </div>
    </div>

    <!-- Zone des messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" #messagesContainer>
      <!-- Message de bienvenue du test -->
      <div *ngIf="testMessages.length === 0 && !isTestStarted" class="text-center py-8">
        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-play text-white text-xl"></i>
        </div>
        <h4 class="text-lg font-semibold text-gray-800 mb-2">Test du Flow</h4>
        <p class="text-gray-600 mb-4">Simulation en temps r√©el de votre chatbot avec {{ nodes.length }} n≈ìuds configur√©s</p>
        <button
          (click)="startFlowTest()"
          class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105"
        >
          <i class="fas fa-rocket mr-2"></i>D√©marrer la simulation
        </button>
      </div>

      <!-- Messages du chat -->
      <div
        *ngFor="let message of testMessages; let i = index"
        [class]="'flex ' + (message.type === 'user' ? 'justify-end' : 'justify-start')"
      >
        <div
          [class]="
            'max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ' +
            (message.type === 'user'
              ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white'
              : 'bg-white shadow-md border border-gray-200')
          "
        >
          <div class="flex items-start space-x-2">
            <!-- Avatar bot -->
            <div
              *ngIf="message.type === 'bot'"
              class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <i class="fas fa-robot text-white text-xs"></i>
            </div>

            <div class="flex-1">
              <!-- Contenu du message -->
              <p [class]="'text-sm ' + (message.type === 'user' ? 'text-white' : 'text-gray-800')">
                {{ message.content }}
              </p>

              <!-- Boutons interactifs -->
              <div *ngIf="message.buttons && message.buttons.length > 0" class="mt-3 space-y-2">
                <button
                  *ngFor="let button of message.buttons"
                  (click)="handleTestButtonClick(button, message)"
                  [disabled]="message.buttonsDisabled"
                  class="w-full text-left px-3 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 text-sm font-medium shadow-sm hover:shadow-md transform hover:scale-105 disabled:transform-none"
                >
                  {{ button.text }}
                </button>
              </div>

              <!-- Timestamp -->
              <p [class]="'text-xs mt-1 ' + (message.type === 'user' ? 'text-blue-100' : 'text-gray-500')">
                {{ formatMessageTime(message.timestamp) }}
                <span *ngIf="message.nodeInfo" class="ml-2 opacity-75"> ‚Ä¢ {{ message.nodeInfo }} </span>
              </p>
            </div>

            <!-- Avatar utilisateur -->
            <div
              *ngIf="message.type === 'user'"
              class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <i class="fas fa-user text-white text-xs"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Indicateur de frappe -->
      <div *ngIf="isTyping" class="flex justify-start">
        <div class="bg-white shadow-md border border-gray-200 rounded-2xl px-4 py-3 max-w-xs">
          <div class="flex items-center space-x-2">
            <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
              <i class="fas fa-robot text-white text-xs"></i>
            </div>
            <div class="flex space-x-1">
              <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
              <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Informations de debug (optionnel) -->
      <div *ngIf="testSession && showDebugInfo" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs">
        <div class="font-semibold text-yellow-800 mb-2">Debug Info:</div>
        <div class="text-yellow-700">
          <div>Variables: {{ getVariablesDebugString() }}</div>
          <div>N≈ìud actuel: {{ currentTestNode?.id || 'Aucun' }}</div>
          <div>√âtape: {{ currentTestStep }}</div>
        </div>
      </div>
    </div>

    <!-- Zone de saisie -->
    <div class="border-t bg-white p-4">
      <div class="flex items-center space-x-3">
        <div class="flex-1 relative">
          <input
            [(ngModel)]="testInputValue"
            (keydown.enter)="sendTestMessage()"
            [disabled]="isTyping || isWaitingForButton || isTestCompleted"
            type="text"
            placeholder="Tapez votre message..."
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all disabled:bg-gray-100 disabled:cursor-not-allowed"
          />
        </div>
        <button
          (click)="sendTestMessage()"
          [disabled]="!testInputValue.trim() || isTyping || isWaitingForButton || isTestCompleted"
          class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-xl hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:transform-none"
        >
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>

      <!-- Instructions -->
      <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
        <span>Appuyez sur Entr√©e pour envoyer</span>
        <div class="flex items-center space-x-3">
          <label class="flex items-center space-x-1 cursor-pointer">
            <input type="checkbox" [(ngModel)]="showDebugInfo" class="rounded" />
            <span>Debug</span>
          </label>
          <span *ngIf="!isTestCompleted">Test en cours...</span>
          <span *ngIf="isTestCompleted" class="text-green-600 font-medium">‚úì Test termin√©</span>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Toast simple -->
<div
  *ngIf="currentToast"
  [class]="
    'fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ' +
    (currentToast.type === 'success'
      ? 'bg-green-500'
      : currentToast.type === 'error'
        ? 'bg-red-500'
        : currentToast.type === 'warning'
          ? 'bg-orange-500'
          : 'bg-blue-500')
  "
>
  <div class="flex items-center space-x-2">
    <i
      [class]="
        currentToast.type === 'success'
          ? 'fas fa-check-circle'
          : currentToast.type === 'error'
            ? 'fas fa-exclamation-circle'
            : currentToast.type === 'warning'
              ? 'fas fa-exclamation-triangle'
              : 'fas fa-info-circle'
      "
    ></i>
    <span class="text-sm font-medium">{{ currentToast.message }}</span>
    <button (click)="currentToast = null" class="text-white hover:text-gray-200">
      <i class="fas fa-times text-xs"></i>
    </button>
  </div>
</div>
