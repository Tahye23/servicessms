<div *ngIf="loading" class="p-4 text-center">
  <div class="animate-spin h-8 w-8 border-4 border-blue-500 rounded-full mx-auto"></div>
</div>

<div *ngIf="error" class="p-4 text-red-600">{{ error }}</div>

<div *ngIf="sms" class="max-w-md mx-auto bg-white shadow-md rounded-lg p-6 space-y-4">
  <h2 class="text-xl font-semibold text-gray-800">DÃ©tail du SMS #{{ sms.id }}</h2>
  <h2 class="text-xl font-semibold text-gray-800">Message Id #{{ sms.messageId }}</h2>
  <div class="space-y-2">
    <p><span class="font-medium">Destinataire:</span> {{ sms.receiver }}</p>
    <p><span class="font-medium">Nom:</span> {{ sms.namereceiver }}</p>
    <p><span class="font-medium">Message:</span> {{ sms.msgdata }}</p>
    <p>
      <span class="font-medium">Statut:</span>
      <span
        [ngClass]="{
          'bg-blue-100 text-blue-700 border border-blue-200': sms.deliveryStatus === 'delivered',
          'bg-green-100 text-green-700 border border-green-200': sms.deliveryStatus === 'read',
          'bg-yellow-100 text-yellow-700 border border-yellow-200': sms.deliveryStatus === 'pending',
          'bg-orange-100 text-orange-700 border border-orange-200': sms.deliveryStatus === 'sent',
          'bg-red-100 text-red-700 border border-red-200': sms.deliveryStatus === 'failed',
          'bg-gray-100 text-gray-600 border border-gray-200': !sms.deliveryStatus
        }"
        class="font-semibold px-2 py-1 rounded"
      >
        {{ sms.deliveryStatus }}
      </span>
    </p>
    <p>
      <span class="font-medium">EnvoyÃ© le:</span>
      {{ sms.sendDate ? (sms.sendDate | date: 'dd/MM/yyyy HH:mm:ss') : 'â€”' }}
    </p>
    <div class="mt-4 text-right text-xs text-gray-500">
      <span class="mr-2">CaractÃ¨res: {{ sms.msgdata?.length || 0 }}</span>
      <span>SMS: {{ sms.msgdata ? Math.ceil(sms.msgdata.length / 160) : 0 }}</span>
    </div>
    <p><span class="font-medium">Segments:</span> {{ sms.totalMessage }}</p>

    <div *ngIf="sms.msgdata">
      <app-template-renderer *ngIf="!isSms" [templateId]="sms.template_id" [variables]="sms.vars"> </app-template-renderer>
      <span *ngIf="isSms && !loading" class="font-medium">Contenu:</span>
      <div *ngIf="isSms && !loading" class="mt-1 p-3 bg-gray-50 rounded break-words whitespace-pre-wrap w-full">
        {{ sms.msgdata }}
      </div>
    </div>

    <div *ngIf="sms.last_error" class="text-xs text-red-600 mt-1 p-2 bg-red-50 rounded">âš ï¸ {{ sms.last_error }}</div>
  </div>

  <!-- âœ… NOUVEAUX MESSAGES DE FEEDBACK -->
  <div *ngIf="sendSuccess" class="p-3 bg-green-50 border border-green-200 text-green-700 rounded">âœ… Message envoyÃ© avec succÃ¨s !</div>

  <div *ngIf="sendError" class="p-3 bg-red-50 border border-red-200 text-red-700 rounded">âŒ {{ sendError }}</div>

  <!-- âœ… BOUTONS D'ACTION -->
  <div class="flex gap-2 mt-6">
    <button (click)="goBack()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded transition">Retour</button>

    <!-- Bouton Envoyer (visible seulement si status = pending ou failed) -->
    <button
      *ngIf="canSend()"
      (click)="sendSms(false)"
      [disabled]="sending"
      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span *ngIf="!sending">ğŸ“¤ Envoyer</span>
      <span *ngIf="sending" class="flex items-center gap-2">
        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        Envoi...
      </span>
    </button>

    <!-- Bouton Test (visible seulement si status = pending ou failed) -->
    <button
      *ngIf="canSend()"
      (click)="sendSms(true)"
      [disabled]="sending"
      class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
    >
      ğŸ§ª Test
    </button>

    <!-- Badge si dÃ©jÃ  envoyÃ© -->
    <div *ngIf="!canSend() && sms.deliveryStatus === 'sent'" class="px-4 py-2 bg-green-100 text-green-700 rounded flex items-center gap-2">
      âœ… DÃ©jÃ  envoyÃ©
    </div>

    <!-- Badge si dÃ©jÃ  livrÃ© -->
    <div
      *ngIf="!canSend() && sms.deliveryStatus === 'delivered'"
      class="px-4 py-2 bg-blue-100 text-blue-700 rounded flex items-center gap-2"
    >
      ğŸ“¬ DÃ©jÃ  livrÃ©
    </div>
  </div>
</div>
